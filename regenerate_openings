#!/bin/bash

# REGENERATE_OPENINGS - Regenerate chess FEN files
#
# Creates verified FEN files from:
# - Known correct opening move sequences (using pgn_to_fen utility)
# - Known correct tactical demonstration positions (direct FEN strings)
# Compatible with both macOS (bash 3.2) and Linux (bash 4+).

regenerate_opening() {
    local opening_name="$1"
    local moves="$2"
    local output_file="FEN_FILES/${opening_name}.fen"

    echo "üîÑ Regenerating $opening_name..."
    echo "   Moves: $moves"

    # Generate FEN using pgn_to_fen
    if echo "$moves" | ./pgn_to_fen > "$output_file.tmp" 2>/dev/null; then
        # Extract just the FEN positions (remove the commentary)
        grep "^[rnbqkpRNBQKP1-8/]" "$output_file.tmp" > "$output_file"
        rm "$output_file.tmp"

        # Validate the generated file
        if ./validate_openings "$output_file" >/dev/null 2>&1; then
            echo "‚úÖ $opening_name: Successfully regenerated and validated"
            return 0
        else
            echo "‚ùå $opening_name: Generated file failed validation"
            return 1
        fi
    else
        echo "‚ùå $opening_name: Failed to generate FEN from moves"
        return 1
    fi
}

regenerate_demonstration() {
    local demo_name="$1"
    local fen_position="$2"
    local output_file="FEN_FILES/${demo_name}.fen"

    echo "üîÑ Regenerating $demo_name (tactical position)..."
    echo "   Position: ${fen_position:0:50}..."

    # Write the FEN position directly to the file
    echo "$fen_position" > "$output_file"

    # Validate the generated file
    if ./validate_openings "$output_file" >/dev/null 2>&1; then
        echo "‚úÖ $demo_name: Successfully regenerated and validated"
        return 0
    else
        echo "‚ùå $demo_name: Generated file failed validation"
        return 1
    fi
}

main() {
    echo "üèóÔ∏è  Regenerating chess FEN files..."
    echo

    # Regenerate opening sequence files (UPPERCASE names)
    echo "üìñ Regenerating opening sequence files..."
    regenerate_opening "RUY_LOPEZ" "e4 e5 Nf3 Nc6 Bb5 a6 Ba4 Nf6 O-O Be7 Re1 b5 Bb3 d6 c3 O-O h3"
    regenerate_opening "ITALIAN" "e4 e5 Nf3 Nc6 Bc4 Bc5 c3 f5 d3 fxe4 dxe4 Nf6 O-O d6 Bg5"
    regenerate_opening "QUEENS_GAMBIT" "d4 d5 c4 e6 Nc3 Nf6 Bg5 Be7 e3 O-O Nf3 Nbd7 Rc1 c6 Bd3"
    regenerate_opening "KINGS_GAMBIT" "e4 e5 f4 exf4 Nf3 g5 h4 g4 Ne5 Nf6 Bc4 d6 Nf7 Qe7 Nxh8"
    regenerate_opening "FRENCH_DEFENSE" "e4 e6 d4 d5 Nc3 Bb4 e5 c5 a3 Bxc3+ bxc3 Ne7 Qg4 Qc7 Qxg7"
    regenerate_opening "CARO_KANN" "e4 c6 d4 d5 Nc3 dxe4 Nxe4 Bf5 Ng3 Bg6 h4 h6 Nf3 Nd7 h5"
    regenerate_opening "SICILIAN_FOUR_KNIGHTS" "e4 c5 Nf3 Nc6 Nc3 Nf6 Bb5 Qc7 O-O Nd4 Re1 a6 Bf1"
    regenerate_opening "ALEKHINES_DEFENSE" "e4 Nf6 e5 Nd5 d4 d6 Nf3 g6 Bc4 Nb6 Bb3 Bg7 Qe2 Nc6"
    regenerate_opening "SCANDINAVIAN" "e4 d5 exd5 Qxd5 Nc3 Qa5 d4 Nf6 Nf3 Bf5 Bc4 e6 Bd2 c6"
    regenerate_opening "NIMZO_INDIAN" "d4 Nf6 c4 e6 Nc3 Bb4 e3 O-O Bd3 d5 Nf3 c5 O-O Nc6 a3"
    regenerate_opening "ENGLISH" "c4 e5 Nc3 Nf6 Nf3 Nc6 g3 d5 cxd5 Nxd5 Bg2 Nxc3 bxc3 Bd6"
    regenerate_opening "KINGS_INDIAN" "d4 Nf6 c4 g6 Nc3 Bg7 e4 d6 Nf3 O-O Bg5 c5 d5 e6 Qd2 exd5 cxd5"

    echo
    echo "üéØ Regenerating tactical demonstration files..."
    regenerate_demonstration "BackRank" "r5k1/5ppp/8/8/8/8/5PPP/4R1K1 w - - 0 1"
    regenerate_demonstration "Castling" "r3k2r/pppppppp/8/8/8/8/PPPPPPPP/R3K2R w KQkq - 0 1"
    regenerate_demonstration "Check" "rnbqkbnr/ppppp1pp/5p2/8/4P3/8/PPPP1PPP/RNBQKBNR w KQkq - 0 2"
    regenerate_demonstration "Checkmate" "6k1/5ppp/8/8/8/8/5PPP/R5K1 w - - 0 1"
    regenerate_demonstration "Discovery" "rnbqkbnr/pppp1p1p/8/8/8/4N3/PPPPQPPP/RNB1KB1R w KQkq - 0 1"
    regenerate_demonstration "EnPassant" "rnbqkbnr/ppp1p1pp/8/3pPp2/8/8/PPPP1PPP/RNBQKBNR w KQkq f6 0 3"
    regenerate_demonstration "FiftyMoveRule" "8/8/8/8/8/4k3/8/4K3 w - - 98 75"
    regenerate_demonstration "Fork" "rnbqkbnr/ppqp1ppp/5r2/3N4/8/8/PPPP1PPP/R1BQKB1R w KQkq - 0 1"
    regenerate_demonstration "Pin" "rnbqkbnr/pppppppp/8/1B6/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"
    regenerate_demonstration "Promotion" "r1bqkb1r/ppppPppp/2n2n2/8/8/8/PPPP1PPP/RNBQKBNR w KQkq - 0 5"
    regenerate_demonstration "Sacrifice" "r1bqk2r/pppp1ppp/2n2n2/2b1p3/2B1P3/3P1N2/PPP2PPP/RNBQK2R w KQkq - 4 5"
    regenerate_demonstration "Stalemate" "8/8/8/8/8/1Q6/p7/k1K5 w - - 0 1"

    echo
    echo "üéØ Regeneration complete! All files now contain authentic sequences and positions."
    echo "   Run './validate_openings' to verify all positions are legal."
    echo "   Run './verify_openings' to verify authenticity against expected patterns."
}

main "$@"