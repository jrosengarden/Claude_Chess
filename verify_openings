#!/bin/bash

# VERIFY_OPENINGS - Chess Opening Authenticity Verification Script
#
# Verifies that FEN files represent authentic classical openings
# by checking the first few moves against known opening sequences.

# Known opening move sequences (first 3-4 moves)
declare -A OPENING_MOVES=(
    ["RUY_LOPEZ"]="e4 e5 Nf3 Nc6 Bb5"
    ["ITALIAN"]="e4 e5 Nf3 Nc6 Bc4"
    ["QUEENS_GAMBIT"]="d4 d5 c4"
    ["KINGS_GAMBIT"]="e4 e5 f4"
    ["FRENCH_DEFENSE"]="e4 e6"
    ["CARO_KANN"]="e4 c6"
    ["SICILIAN_FOUR_KNIGHTS"]="e4 c5 Nf3 Nc6 Nc3 Nf6"
    ["ALEKHINES_DEFENSE"]="e4 Nf6"
    ["SCANDINAVIAN"]="e4 d5"
    ["NIMZO_INDIAN"]="d4 Nf6 c4 e6 Nc3 Bb4"
    ["ENGLISH"]="c4"
    ["KINGS_INDIAN"]="d4 Nf6 c4 g6 Nc3 Bg7 e4 d6 Nf3 O-O"
)

verify_opening() {
    local file="$1"
    local basename=$(basename "$file" .fen)
    local expected_moves="${OPENING_MOVES[$basename]}"

    if [[ -z "$expected_moves" ]]; then
        echo "‚ö†Ô∏è  $basename: No verification pattern defined"
        return 0
    fi

    echo "üîç Verifying $basename..."
    echo "   Expected: $expected_moves"

    # Generate FEN from expected moves
    local generated_fen=$(echo "$expected_moves" | ./pgn_to_fen 2>/dev/null | tail -n +2 | head -n -1)

    if [[ -z "$generated_fen" ]]; then
        echo "‚ùå $basename: Could not generate expected FEN sequence"
        return 1
    fi

    # Get corresponding lines from existing file
    local move_count=$(echo "$expected_moves" | wc -w)
    local positions_needed=$((move_count + 1))  # +1 for starting position
    local existing_fen=$(head -n "$positions_needed" "$file")

    # Compare sequences
    if [[ "$generated_fen" == "$existing_fen" ]]; then
        echo "‚úÖ $basename: Opening sequence verified as authentic"
        return 0
    else
        echo "‚ùå $basename: Opening sequence does NOT match expected moves"
        echo "   First difference:"
        diff <(echo "$expected_moves" | ./pgn_to_fen 2>/dev/null) <(head -n "$positions_needed" "$file") | head -n 5
        return 1
    fi
}

main() {
    local issues=0

    echo "üèÅ Verifying chess opening authenticity..."
    echo

    for file in FEN_FILES/*.fen; do
        if [[ -f "$file" ]] && [[ "$(basename "$file")" != "SAVE_ME.fen" ]]; then
            if ! verify_opening "$file"; then
                issues=$((issues + 1))
            fi
            echo
        fi
    done

    echo "üìä SUMMARY:"
    if [[ $issues -eq 0 ]]; then
        echo "‚úÖ All verified openings are authentic!"
    else
        echo "‚ùå $issues opening(s) have authenticity issues"
        echo
        echo "üîß To fix inauthentic openings, run:"
        echo "   ./regenerate_openings [opening_name]"
    fi

    return $issues
}

main "$@"